{% extends "pingpong/base.html" %}
{% load static %}

{% block title %}Leaderboard - Table Tennis Tracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <div>
        <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Leaderboard üèÜ</h2>
        <p class="text-muted-foreground mt-1 text-sm md:text-base">Player rankings and statistics</p>
    </div>

    <!-- Filters Card -->
    <div class="rounded-lg border bg-white p-4 md:p-6">
        <form method="get" id="filter-form" class="space-y-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base md:text-lg font-semibold flex items-center gap-2">
                    <img src="{% static 'pingpong/icons/funnel.svg' %}" class="w-5 h-5" alt="">
                    Filters
                </h3>
                <button type="button" id="reset-filters" class="text-sm text-muted-foreground hover:text-foreground
                transition-colors">
                    Reset All
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Match Type Filter -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" for="match_type">
                        Match Type
                    </label>
                    <select name="match_type" id="match_type"
                            class="flex h-12 w-full rounded-md border border-input bg-white px-3 py-2 text-base
                            md:text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                        <option value="all" {% if match_type == 'all' %}selected{% endif %}>All Matches</option>
                        <option value="singles" {% if match_type == 'singles' %}selected{% endif %}>Singles (1v1) Only</option>
                        <option value="doubles" {% if match_type == 'doubles' %}selected{% endif %}>Doubles (2v2) Only</option>
                    </select>
                    <p class="text-xs text-muted-foreground">Filter by match format</p>
                </div>

                <!-- Date Filter -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" for="date_filter">
                        Time Period
                    </label>
                    <select name="date_filter" id="date_filter"
                            class="flex h-12 w-full rounded-md border border-input bg-white px-3 py-2 text-base
                            md:text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                        <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                        <option value="month" {% if date_filter == 'month' %}selected{% endif %}>Last Month</option>
                        <option value="3months" {% if date_filter == '3months' %}selected{% endif %}>Last 3 Months</option>
                        <option value="6months" {% if date_filter == '6months' %}selected{% endif %}>Last 6 Months</option>
                        <option value="year" {% if date_filter == 'year' %}selected{% endif %}>Last Year</option>
                        <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                    <p class="text-xs text-muted-foreground">Filter by date range</p>
                </div>

                <!-- Top X Filter -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" for="top_x">
                        Show Top Players
                    </label>
                    <select name="top_x" id="top_x"
                            class="flex h-12 w-full rounded-md border border-input bg-white px-3 py-2 text-base md:text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                        <option value="10" {% if top_x == '10' %}selected{% endif %}>Top 10</option>
                        <option value="20" {% if top_x == '20' %}selected{% endif %}>Top 20</option>
                        <option value="50" {% if top_x == '50' %}selected{% endif %}>Top 50</option>
                        <option value="100" {% if top_x == '100' %}selected{% endif %}>Top 100</option>
                    </select>
                    <p class="text-xs text-muted-foreground">Limit results by ranking</p>
                </div>
            </div>

            <!-- Custom Date Range (hidden by default) -->
            <div id="custom-date-range" class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t
            {% if date_filter != 'custom' %}hidden{% endif %}">
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" for="start_date">
                        Start Date
                    </label>
                    <input type="date" name="start_date" id="start_date"
                           value="{{ start_date }}"
                           class="flex h-12 w-full rounded-md border border-input bg-white px-3 py-2 text-base
                           md:text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none" for="end_date">
                        End Date
                    </label>
                    <input type="date" name="end_date" id="end_date"
                           value="{{ end_date }}"
                           class="flex h-12 w-full rounded-md border border-input bg-white px-3 py-2 text-base
                           md:text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-md bg-primary
                    px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors min-h-[44px]">
                        <img src="{% static 'pingpong/icons/check-line.svg' %}" class="w-4 h-4 invert" alt="">
                        Apply Custom Range
                    </button>
                </div>
            </div>

            <!-- Active Filters Display -->
            {% if match_type != 'all' or date_filter != 'all' or top_x != '10' %}
            <div class="flex flex-wrap gap-2 pt-4 border-t">
                <span class="text-sm text-muted-foreground">Active filters:</span>
                {% if match_type == 'singles' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Singles Only
                    <button type="button" onclick="clearFilter('match_type')" class="hover:text-destructive">√ó</button>
                </span>
                {% elif match_type == 'doubles' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Doubles Only
                    <button type="button" onclick="clearFilter('match_type')" class="hover:text-destructive">√ó</button>
                </span>
                {% endif %}

                {% if date_filter == 'month' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Last Month
                    <button type="button" onclick="clearFilter('date_filter')" class="hover:text-destructive">√ó</button>
                </span>
                {% elif date_filter == '3months' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Last 3 Months
                    <button type="button" onclick="clearFilter('date_filter')" class="hover:text-destructive">√ó</button>
                </span>
                {% elif date_filter == '6months' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Last 6 Months
                    <button type="button" onclick="clearFilter('date_filter')" class="hover:text-destructive">√ó</button>
                </span>
                {% elif date_filter == 'year' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Last Year
                    <button type="button" onclick="clearFilter('date_filter')" class="hover:text-destructive">√ó</button>
                </span>
                {% elif date_filter == 'custom' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Custom: {{ start_date }} to {{ end_date }}
                    <button type="button" onclick="clearFilter('date_filter')" class="hover:text-destructive">√ó</button>
                </span>
                {% endif %}

                {% if top_x != '10' %}
                <span class="inline-flex items-center gap-1 rounded-md bg-primary/10 px-2 py-1 text-xs font-medium">
                    Top {{ top_x }}
                    <button type="button" onclick="clearFilter('top_x')" class="hover:text-destructive">√ó</button>
                </span>
                {% endif %}
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Results Count -->
    {% if player_stats %}
    <div class="text-sm text-muted-foreground">
        Showing {{ player_stats|length }} player{{ player_stats|length|pluralize }}
        {% if match_type == 'singles' %}(Singles only){% elif match_type == 'doubles' %}(Doubles only){% endif %}
        {% if date_filter != 'all' %}
            {% if date_filter == 'custom' %}from {{ start_date }} to {{ end_date }}{% else %}in selected time period{% endif %}
        {% endif %}
    </div>
    {% endif %}

    <!-- Leaderboard Table -->
    {% if player_stats %}
    <div class="rounded-lg border bg-white overflow-hidden">
        <!-- Desktop Table (hidden on mobile/tablet) -->
        <div class="hidden lg:block overflow-x-auto">
            <table class="w-full">
                <thead class="border-b bg-muted/50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Rank</th>
                        <th class="px-6 py-4 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">Elo</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Player</th>
                        <th class="px-6 py-4 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">Matches</th>
                        <th class="px-6 py-4 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">Games</th>
                        <th class="px-6 py-4 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">Wins</th>
                        <th class="px-6 py-4 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">Losses</th>
                        <th class="px-6 py-4 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">Win Rate</th>
                        <th class="px-6 py-4 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for stat in player_stats %}
                    <tr class="hover:bg-muted/50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if forloop.counter == 1 %}
                                <span class="text-2xl font-bold text-warning">ü•á</span>
                                {% elif forloop.counter == 2 %}
                                <span class="text-2xl font-bold" style="filter: grayscale(0.3);">ü•à</span>
                                {% elif forloop.counter == 3 %}
                                <span class="text-2xl font-bold" style="filter: brightness(0.8);">ü•â</span>
                                {% else %}
                                <span class="text-lg font-semibold text-muted-foreground ml-2">{{ forloop.counter }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex flex-col items-center">
                                <span class="text-xl font-bold text-primary">{{ stat.elo_rating }}</span>
                                <span class="text-xs text-muted-foreground">Peak: {{ stat.elo_peak }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-semibold">
                                    {{ stat.player.name|slice:":1"|upper }}
                                </div>
                                <div>
                                    <a href="{% url 'pingpong:player_detail' stat.player.pk %}" class="font-medium hover:underline">
                                        {{ stat.player }}
                                    </a>
                                    {% if stat.player.playing_style != 'unknown' %}
                                    <div class="text-xs text-muted-foreground">{{ stat.player.get_playing_style_display }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="font-semibold">{{ stat.total_matches }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="text-sm text-muted-foreground">{{ stat.total_games }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center rounded-md bg-success/10 px-2.5 py-1 text-sm font-semibold text-success">
                                {{ stat.wins }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center rounded-md bg-destructive/10 px-2.5 py-1 text-sm font-semibold text-destructive">
                                {{ stat.losses }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-lg font-bold">{{ stat.win_rate|floatformat:1 }}%</span>
                                <div class="w-24 bg-secondary rounded-full h-2">
                                    <div class="{% if stat.win_rate >= 70 %}bg-success{% elif stat.win_rate >= 50 %}bg-warning{% else %}bg-primary{% endif %} h-2 rounded-full transition-all" style="width: {{ stat.win_rate }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <a href="{% url 'pingpong:player_detail' stat.player.pk %}" class="inline-flex items-center gap-1 text-sm font-medium hover:underline">
                                View Profile
                                <img src="{% static 'pingpong/icons/arrow-right.svg' %}" class="w-4 h-4" alt="">
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile/Tablet Ranking Cards -->
        <div class="lg:hidden divide-y">
            {% for stat in player_stats %}
            <div class="p-4 hover:bg-muted/50 transition-colors {% if forloop.counter <= 3 %}bg-muted/30{% endif %}">
                <!-- Rank & Player Info -->
                <div class="flex items-start gap-3 mb-3">
                    <!-- Rank Badge -->
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center">
                        {% if forloop.counter == 1 %}
                        <span class="text-3xl">ü•á</span>
                        {% elif forloop.counter == 2 %}
                        <span class="text-3xl" style="filter: grayscale(0.3);">ü•à</span>
                        {% elif forloop.counter == 3 %}
                        <span class="text-3xl" style="filter: brightness(0.8);">ü•â</span>
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-muted flex items-center justify-center">
                            <span class="text-lg font-bold text-muted-foreground">{{ forloop.counter }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Player Info -->
                    <div class="flex-1 min-w-0">
                        <a href="{% url 'pingpong:player_detail' stat.player.pk %}" class="font-semibold text-base hover:underline block truncate">
                            {{ stat.player }}
                        </a>
                        {% if stat.player.playing_style != 'unknown' %}
                        <div class="text-xs text-muted-foreground">{{ stat.player.get_playing_style_display }}</div>
                        {% endif %}
                    </div>

                    <!-- Elo Rating (prominent) -->
                    <div class="flex-shrink-0 text-right">
                        <div class="text-xl font-bold text-primary">
                            {{ stat.elo_rating }}
                        </div>
                        <div class="text-xs text-muted-foreground">Elo Rating</div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-5 gap-2 mb-3">
                    <div class="text-center p-2 bg-primary/10 rounded-md">
                        <div class="text-base font-bold text-primary">{{ stat.elo_peak }}</div>
                        <div class="text-xs text-muted-foreground">Peak</div>
                    </div>
                    <div class="text-center p-2 bg-secondary rounded-md">
                        <div class="text-base font-bold">{{ stat.total_matches }}</div>
                        <div class="text-xs text-muted-foreground">Matches</div>
                    </div>
                    <div class="text-center p-2 bg-secondary rounded-md">
                        <div class="text-base font-bold">{{ stat.total_games }}</div>
                        <div class="text-xs text-muted-foreground">Games</div>
                    </div>
                    <div class="text-center p-2 bg-success/10 rounded-md">
                        <div class="text-base font-bold text-success">{{ stat.wins }}</div>
                        <div class="text-xs text-success">Wins</div>
                    </div>
                    <div class="text-center p-2 bg-destructive/10 rounded-md">
                        <div class="text-base font-bold text-destructive">{{ stat.losses }}</div>
                        <div class="text-xs text-destructive">Losses</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-2">
                    <div class="w-full bg-secondary rounded-full h-2">
                        <div class="{% if stat.win_rate >= 70 %}bg-success{% elif stat.win_rate >= 50 %}bg-warning{% else %}bg-primary{% endif %} h-2 rounded-full transition-all" style="width: {{ stat.win_rate }}%"></div>
                    </div>
                </div>

                <!-- View Profile Link -->
                <a href="{% url 'pingpong:player_detail' stat.player.pk %}" class="flex items-center justify-center gap-2 text-sm font-medium hover:underline text-primary py-2 min-h-[44px]">
                    View Full Profile
                    <img src="{% static 'pingpong/icons/arrow-right.svg' %}" class="w-4 h-4" alt="">
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="rounded-lg border bg-white p-8 md:p-12 text-center">
        <img src="{% static 'pingpong/icons/trophy.svg' %}" class="w-16 h-16 mx-auto text-muted-foreground mb-4 opacity-30" alt="">
        <h3 class="text-xl font-semibold mb-2">No Rankings Found</h3>
        <p class="text-muted-foreground mb-6 text-sm md:text-base">
            {% if match_type != 'all' or date_filter != 'all' %}
                No players match the selected filters. Try adjusting your search criteria.
            {% else %}
                Start adding players and recording matches to see the leaderboard
            {% endif %}
        </p>
        {% if match_type != 'all' or date_filter != 'all' %}
            <button type="button" onclick="resetFilters()" class="inline-flex items-center justify-center gap-2 rounded-md bg-primary px-4 py-2.5 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors min-h-[44px]">
                <img src="{% static 'pingpong/icons/funnel.svg' %}" class="w-4 h-4 invert" alt="">
                Clear All Filters
            </button>
        {% else %}
            <a href="{% url 'pingpong:player_add' %}" class="inline-flex items-center justify-center gap-2 rounded-md bg-primary px-4 py-2.5 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors min-h-[44px]">
                <img src="{% static 'pingpong/icons/user-plus.svg' %}" class="w-4 h-4 invert" alt="">
                Add First Player
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    function toggleCustomDateRange() {
        const dateFilter = document.getElementById('date_filter').value;
        const customRange = document.getElementById('custom-date-range');

        if (dateFilter === 'custom') {
            customRange.classList.remove('hidden');
        } else {
            customRange.classList.add('hidden');
        }
    }

    function clearFilter(filterName) {
        const form = document.getElementById('filter-form');
        const input = form.querySelector(`[name="${filterName}"]`);
        if (input) {
            input.value = 'all';
            form.submit();
        }
    }

    function resetFilters() {
        window.location.href = window.location.pathname;
    }

    // Set reset button handler
    document.getElementById('reset-filters').addEventListener('click', resetFilters);

    // Initialize custom date range visibility on page load
    document.addEventListener('DOMContentLoaded', function() {
        toggleCustomDateRange();

        // Add change listeners for auto-submit
        document.getElementById('match_type').addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });

        document.getElementById('date_filter').addEventListener('change', function() {
            toggleCustomDateRange();
            // Only auto-submit if not custom (custom needs manual apply)
            if (this.value !== 'custom') {
                document.getElementById('filter-form').submit();
            }
        });

        document.getElementById('top_x').addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });
    });
</script>
{% endblock %}
