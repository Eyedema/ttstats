name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  test:
    name: Run Tests & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git diff

      - name: Check for Python file changes
        id: check_files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check files changed between base and head
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            # For pushes, check files in the current commit
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -q "\.py$"; then
            echo "Python files were changed"
            echo "py_changed=true" >> $GITHUB_OUTPUT
          else
            echo "No Python files were changed"
            echo "py_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check_files.outputs.py_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        if: steps.check_files.outputs.py_changed == 'true'
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        if: steps.check_files.outputs.py_changed == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Ensure pytest and plugins are installed if not in requirements.txt
          pip install pytest pytest-django pytest-cov

      - name: Run tests with pytest
        if: steps.check_files.outputs.py_changed == 'true'
        env:
          DJANGO_SETTINGS_MODULE: ttstats.settings
          SECRET_KEY: "test-secret-key-for-ci-only"
        run: |
          cd ttstats
          # Running pytest as defined in your script
          pytest --cov=pingpong --cov-config=../.coveragerc --cov-report=term --cov-report=html -v

      - name: Generate coverage summary
        if: steps.check_files.outputs.py_changed == 'true'
        id: coverage
        run: |
          cd ttstats
          # Generate plain text report for the PR comment parsing
          coverage report > coverage_report.txt

          # Add to GitHub step summary
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage_report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Extract coverage percentage (keeping % sign for display)
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}')
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the detailed HTML report from the artifacts section below." >> $GITHUB_STEP_SUMMARY

          # Console output
          echo ""
          echo "ðŸ“Š Coverage Report:"
          echo "===================="
          cat coverage_report.txt
          echo ""
          echo "âœ… Total Coverage: $COVERAGE"

          # Save for next step
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Skip message
        if: steps.check_files.outputs.py_changed == 'false'
        run: |
          echo "â­ï¸  Skipping tests - no Python files were changed" >> $GITHUB_STEP_SUMMARY
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && steps.check_files.outputs.py_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageReport = fs.readFileSync('ttstats/coverage_report.txt', 'utf8');
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            
            const comment = `## ðŸ“Š Test Coverage Report
            **Total Coverage:** ${coverage}
            
            \`\`\`
            ${coverageReport}
            \`\`\`
            
            ðŸ“¥ Download detailed HTML report
            The full HTML coverage report is available in the **Artifacts** section of this workflow run.
            Click on "coverage-report" to download and view locally.
            
            âœ… All tests passed!`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload coverage HTML report
        if: steps.check_files.outputs.py_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ttstats/htmlcov/
          retention-days: 30

  deploy:
    name: Deploy to VPS
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd ${{ secrets.WORK_DIR }}
            git pull
            docker compose -f compose.prod.yml up -d --build
            docker compose -f compose.prod.yml exec -T web python manage.py migrate
            docker compose -f compose.prod.yml exec -T web python manage.py collectstatic --noinput

      - name: Deployment status
        run: echo "âœ… Deployment to VPS completed successfully!"
